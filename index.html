<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Expiry Report</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Cairo:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<style>
    :root {
        --font-family: 'Cairo', 'Inter', sans-serif;
        --bg-color: #f4f7f9;
        --card-bg-color: #ffffff;
        --text-primary: #1a202c;
        --text-secondary: #718096;
        --border-color: #e2e8f0;
        --accent-primary: #3182ce;
        --accent-primary-hover: #2b6cb0;
        --accent-success: #38a169;
        --accent-success-hover: #2f855a;
        --accent-danger: #e53e3e;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --border-radius-lg: 12px;
        --border-radius-md: 8px;
    }

    *, *::before, *::after { box-sizing: border-box; }

    body, html {
        margin: 0; padding: 0; font-family: var(--font-family);
        background-color: var(--bg-color); color: var(--text-primary);
        line-height: 1.6;
        -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }

    #app-container { max-width: 960px; margin: 0 auto; padding: 24px 16px; }
    
    h1, h2, h3, p, li, button, input { text-align: start; }

    .app-header {
        text-align: center; margin-bottom: 32px;
        background: linear-gradient(45deg, var(--accent-primary), #63b3ed);
        color: white; padding: 24px; border-radius: var(--border-radius-lg); box-shadow: var(--shadow-md);
    }
    .app-header h1 { margin: 0; font-size: 1.75rem; font-weight: 700; }
    .app-header p { margin: 4px 0 0 0; opacity: 0.9; }
    .app-header a { color: #bee3f8; text-decoration: none; display: block; margin-top: 12px; font-size: 0.9rem; transition: color 0.3s; }
    .app-header a:hover { color: white; }

    .card {
        background-color: var(--card-bg-color); border-radius: var(--border-radius-lg);
        padding: 24px; box-shadow: var(--shadow-md);
        margin-bottom: 24px;
    }
    .card-title {
        font-size: 1.2rem; font-weight: 600; margin: 0 0 16px 0;
        display: flex; align-items: center; gap: 10px; color: var(--text-primary);
    }

    .input-group { display: flex; gap: 8px; align-items: stretch; }
    input[type="text"], input[type="number"] {
        padding: 12px 16px; border: 1px solid var(--border-color); border-radius: var(--border-radius-md); font-size: 1rem;
        font-family: var(--font-family); outline: none; transition: all 0.3s ease;
        width: 100%; background-color: #fff; flex-grow: 1;
    }
    input:focus-visible {
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.2);
    }
    
    button {
        padding: 12px 20px; cursor: pointer; border: none; border-radius: var(--border-radius-md); font-size: 1rem;
        font-weight: 600; font-family: var(--font-family); transition: all 0.3s ease;
        display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        -webkit-tap-highlight-color: transparent;
    }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-icon { padding: 12px; background-color: #fff; border: 1px solid var(--border-color); color: var(--text-secondary); }
    .btn-icon:hover { background-color: #f7fafc; }

    .btn-primary { background-color: var(--accent-primary); color: white; }
    .btn-primary:not(:disabled):hover { background-color: var(--accent-primary-hover); }
    .btn-secondary { background-color: #f7fafc; color: var(--text-primary); border: 1px solid var(--border-color); }
    .btn-secondary:not(:disabled):hover { background-color: #edf2f7; }
    .btn-success { background-color: var(--accent-success); color: white; }
    .btn-success:not(:disabled):hover { background-color: var(--accent-success-hover); }
    
    #workspace-card {
        overflow: hidden; max-height: 0; padding: 0 24px; margin-bottom: 0; opacity: 0;
        border: none; transition: all 0.5s ease;
    }
    #workspace-card.visible {
        max-height: 2000px; padding: 24px; margin-bottom: 24px; opacity: 1;
        border: 1px solid var(--border-color);
    }
    
    .divider { border: none; border-top: 1px solid var(--border-color); margin: 24px 0; }

    .item-details-list { list-style: none; padding: 0; margin: 0 0 24px 0; display: grid; gap: 12px; }
    .item-details-list li { display: flex; flex-wrap: wrap; align-items: baseline; }
    .item-details-list li strong { color: var(--text-secondary); flex-shrink: 0; margin-inline-end: 8px; font-weight: 500; }
    
    /* === MODERN EXPIRY ENTRY LAYOUT === */
    #expiry-inputs-container { display: flex; flex-direction: column; gap: 16px; }
    
    .entry-card {
        background-color: #f7fafc; border: 1px solid var(--border-color);
        border-radius: var(--border-radius-lg); padding: 16px;
        position: relative; animation: fadeIn 0.5s ease;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

    .entry-card-content {
        display: grid; gap: 16px;
    }
    @media (min-width: 600px) {
        .entry-card-content { grid-template-columns: 1fr 120px; }
    }
    .input-wrapper { display: flex; flex-direction: column; gap: 8px; }
    .input-wrapper label { font-weight: 500; font-size: 0.9rem; color: var(--text-secondary); }
    
    .date-actions { display: flex; gap: 8px; margin-top: 4px; }
    .date-pill {
        background: #edf2f7; border: 1px solid var(--border-color);
        padding: 4px 12px; font-size: 0.8rem; font-weight: 500;
        color: var(--text-secondary); cursor: pointer; border-radius: 999px;
    }
    .date-pill:hover { background-color: #e2e8f0; color: var(--text-primary); }

    .btn-remove-entry {
        position: absolute; top: 8px; inset-inline-end: 8px;
        background: none; border: none; color: var(--text-secondary);
        cursor: pointer; padding: 6px; border-radius: 50%;
    }
    .btn-remove-entry:hover { background-color: #edf2f7; color: var(--accent-danger); }
    
    .btn-add-new {
        width: 100%; margin-top: 16px;
        background-color: #f0fff4; color: #2f855a; border: 1px dashed #9ae6b4;
        font-weight: 600;
    }
    .btn-add-new:hover { background-color: #c6f6d5; border-style: solid; }
    
    .workspace-actions {
        display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
    }

    /* Table Styles */
    .table-wrapper { overflow-x: auto; }
    #records-table { width: 100%; border-collapse: collapse; }
    #records-table th, #records-table td { padding: 14px 12px; border-bottom: 1px solid var(--border-color); font-size: 0.9rem; vertical-align: middle; }
    #records-table th { font-weight: 600; color: var(--text-secondary); }
    
    .data-management-buttons { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 600px) {
        .data-management-buttons { grid-template-columns: 1fr 1fr; }
    }
    
    /* Scanner styles */
    #scanner-modal { position: fixed; inset: 0; z-index: 10000; background-color: rgba(0,0,0,0.8); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; flex-direction: column; padding: 20px; }
    #scanner-modal.visible { display: flex; }
    .scanner-container { position: relative; width: 100%; max-width: 600px; margin: 20px 0; border-radius: 15px; overflow: hidden; }
    #scanner-video { width: 100%; display: block; }
    .scan-line { position: absolute; width: 100%; height: 3px; background: #e53e3e; top: 50%; animation: scan 2s infinite ease-in-out; }
    @keyframes scan { 0%{transform:translateY(-50px)} 50%{transform:translateY(50px)} 100%{transform:translateY(-50px)} }
    .scanner-controls { margin-top: 20px; display: flex; gap: 15px; }
    .scanner-controls button { color: white; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); }
    #scanner-status { color: white; margin-top: 15px; }
    
    /* Loader & Toast */
    #loader-overlay { position: fixed; inset: 0; z-index: 9999; background-color: rgba(255,255,255,0.7); backdrop-filter: blur(4px); display: none; justify-content: center; align-items: center; }
    #loader-overlay.visible { display: flex; }
    .spinner { width: 48px; height: 48px; border-radius: 50%; border: 5px solid #dee2e6; border-top-color: var(--accent-primary); animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    #toast { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); background-color: var(--text-primary); color: white; padding: 12px 24px; border-radius: var(--border-radius-md); box-shadow: var(--shadow-md); font-weight: 500; z-index: 10001; transition: all 0.5s ease; }
    #toast.show { bottom: 24px; }
</style>

</head>
<body>
    <div id="loader-overlay"><div style="text-align:center;"><div class="spinner"></div><p id="loader-text">Initializing...</p></div></div>
    <div id="toast"></div>

    <div id="scanner-modal">
        <div class="scanner-container">
            <video id="scanner-video" playsinline autoplay></video>
            <div class="scan-line"></div>
        </div>
        <div class="scanner-controls">
            <button id="scanner-switch-button"><span class="material-icons-outlined">switch_camera</span>Switch Camera</button>
            <button id="scanner-close-button"><span class="material-icons-outlined">close</span>Cancel</button>
        </div>
        <p id="scanner-status">Point camera at a barcode...</p>
    </div>

    <div id="app-container">
        <header class="app-header">
            <h1>Product Expiry Report</h1>
            <p>Keep The Records.</p>
            <a href="../index.html">→ العودة إلى لوحة التحكم</a>
        </header>

        <main>
            <section class="card">
                <h2 class="card-title"><span class="material-icons-outlined">search</span>Find an Item</h2>
                <div class="input-group">
                    <input type="text" id="searchBarcodeInput" placeholder="Scan or Enter Barcode...">
                    <button id="scanButton" class="btn-icon" title="Scan Barcode"><span class="material-icons-outlined">camera_alt</span></button>
                    <button id="searchButton" class="btn-primary" disabled>Search</button>
                </div>
            </section>

            <section id="workspace-card" class="card">
                <h2 class="card-title" id="item-title-display"><span class="material-icons-outlined">inventory_2</span>Item Details</h2>
                <ul id="item-details-list"></ul>
                <hr class="divider">
                
                <h3 class="card-title" style="font-size: 1.1rem; margin-bottom: 16px;"><span class="material-icons-outlined">edit_calendar</span>Record Expiry &amp; Quantity</h3>
                <div id="expiry-inputs-container"></div>
                <button id="add-expiry-button" class="btn-add-new"><span class="material-icons-outlined">add_circle_outline</span>Add New Entry</button>
                
                <hr class="divider">

                <div class="workspace-actions">
                    <button id="discard-button" class="btn-secondary">Discard</button>
                    <button id="save-button" class="btn-success" disabled><span class="material-icons-outlined">check_circle</span>Save Entry</button>
                </div>
            </section>

            <section class="card">
                <h2 class="card-title"><span class="material-icons-outlined">history</span>Recent Entries</h2>
                <div class="table-wrapper"><table id="records-table"></table></div>
            </section>

             <section class="card">
                <h2 class="card-title"><span class="material-icons-outlined">settings</span>Data Management</h2>
                <div class="data-management-buttons">
                    <button id="syncButton" class="btn-secondary"><span class="material-icons-outlined">sync</span>Sync Data</button>
                    <button id="exportButton" class="btn-secondary" disabled><span class="material-icons-outlined">download</span>Export & Clear</button>
                </div>
            </section>
        </main>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    
    <script>
    // === CONFIGURATION ===
    const appsScriptUrl = "https://script.google.com/macros/s/AKfycbx0ZJzBcj0Qtz6fgVEdUKC8gIQa_KJGVCe3CmPoz63NRJPcuL9LkLuFaj6nhYnk-QYMdg/exec";
    const DATE_FORMAT = "d-m-Y";

    // === GLOBAL VARIABLES ===
    let database = [], currentItem = null, enteredRecords = [];
    let barcodeHeader = '', nameHeader = '';
    let editingRecordIndex = null;

    // === DOM ELEMENT CACHE ===
    const el = { 
        loader: document.getElementById('loader-overlay'),
        toast: document.getElementById('toast'),
        searchInput: document.getElementById('searchBarcodeInput'), 
        searchButton: document.getElementById('searchButton'), 
        scanButton: document.getElementById('scanButton'),
        workspace: document.getElementById('workspace-card'), 
        itemTitle: document.getElementById('item-title-display'), 
        itemDetails: document.getElementById('item-details-list'), 
        expiryInputsContainer: document.getElementById('expiry-inputs-container'), 
        addExpiryButton: document.getElementById('add-expiry-button'), 
        discardButton: document.getElementById('discard-button'), 
        saveButton: document.getElementById('save-button'), 
        recordsTable: document.getElementById('records-table'), 
        syncButton: document.getElementById('syncButton'), 
        exportButton: document.getElementById('exportButton'),
        scannerModal: document.getElementById('scanner-modal'),
        scannerVideo: document.getElementById('scanner-video'),
        scannerStatus: document.getElementById('scanner-status'),
        scannerCloseButton: document.getElementById('scanner-close-button'),
        scannerSwitchButton: document.getElementById('scanner-switch-button')
    };
    
    // --- Core App Logic ---
    const showLoader = (msg) => { el.loader.classList.add('visible'); el.loader.querySelector('#loader-text').textContent = msg; };
    const hideLoader = () => el.loader.classList.remove('visible');
    let toastTimeout;
    const showToast = (msg) => { clearTimeout(toastTimeout); el.toast.textContent = msg; el.toast.classList.add('show'); toastTimeout = setTimeout(() => el.toast.classList.remove('show'), 3000); };
    
    const showWorkspace = (item) => { 
        currentItem = item; 
        el.itemTitle.innerHTML = `<span class="material-icons-outlined">inventory_2</span> ${item[nameHeader] || 'Item Details'}`; 
        const detailsToShow = [nameHeader, barcodeHeader, 'supplier name', 'status'].filter(h => item[h]); 
        el.itemDetails.innerHTML = detailsToShow.map(header => `<li><strong>${header.charAt(0).toUpperCase() + header.slice(1)}:</strong> <span>${item[header]}</span></li>`).join(''); 
        el.expiryInputsContainer.innerHTML = ''; 
        addExpiryEntry(); 
        el.workspace.classList.add('visible'); 
        el.saveButton.disabled = false; 
        window.scrollTo({ top: el.workspace.offsetTop - 20, behavior: 'smooth' }); 
    };
    
    const hideWorkspace = () => { 
        currentItem = null; 
        editingRecordIndex = null; 
        el.workspace.classList.remove('visible'); 
        el.searchInput.value = ''; 
        el.searchInput.focus(); 
        el.saveButton.disabled = true; 
    };
    
    const addExpiryEntry = (date = '', quantity = '') => {
        const div = document.createElement('div');
        div.className = 'entry-card';
        div.innerHTML = `
            <button type="button" class="btn-remove-entry" title="Remove Entry" onclick="this.parentElement.remove()">
                <span class="material-icons-outlined">close</span>
            </button>
            <div class="entry-card-content">
                <div class="input-wrapper">
                    <label>تاريخ الانتهاء</label>
                    <input type="text" placeholder="${DATE_FORMAT.replace('Y','yyyy').replace('m','mm').replace('d','dd')}" class="expiry-date" value="${date}">
                    <div class="date-actions">
                        <button type="button" class="date-pill" data-action="today">اليوم</button>
                        <button type="button" class="date-pill" data-action="plus_one_year">+1 سنة</button>
                    </div>
                </div>
                <div class="input-wrapper">
                    <label>الكمية</label>
                    <input type="number" placeholder="e.g., 12" class="quantity-input" min="1" value="${quantity}">
                </div>
            </div>
        `;
        el.expiryInputsContainer.appendChild(div);
        
        const dateInput = div.querySelector('.expiry-date');
        const fpInstance = flatpickr(dateInput, { dateFormat: DATE_FORMAT, allowInput: true, minDate: "today" });
        
        div.querySelectorAll('.date-pill').forEach(btn => {
            btn.addEventListener('click', () => {
                const action = btn.dataset.action;
                let newDate = new Date();
                if (action === 'plus_one_year') newDate.setFullYear(newDate.getFullYear() + 1);
                fpInstance.setDate(newDate, true);
            });
        });
        if (!date) dateInput.focus();
    };

    async function initializeApp() { 
        showLoader('Syncing database...'); 
        loadDataFromLocalStorage(); 
        try { 
            const inventoryData = await fetchDataFromGoogleSheet(); 
            if (inventoryData?.length) { 
                database = inventoryData; 
                const headers = Object.keys(database[0]); 
                barcodeHeader = headers.find(h => h.toLowerCase().includes('barcode')) || ''; 
                nameHeader = headers.find(h => h.toLowerCase().includes('name')) || ''; 
                if (!barcodeHeader || !nameHeader) { 
                    alert("Data Error: Sheet needs 'barcode' and 'name' columns."); 
                    enableButtons(false); 
                } else { 
                    localStorage.setItem('barcodeHeader', barcodeHeader); 
                    localStorage.setItem('nameHeader', nameHeader); 
                    enableButtons(true); 
                    showToast('Data synced successfully!'); 
                } 
            } else { 
                showToast('Sync failed or database is empty.'); 
                enableButtons(database.length > 0); 
            } 
        } catch(e) { 
            showToast('An error occurred during sync.'); 
        } finally { 
            hideLoader(); 
        } 
    }

    const fetchDataFromGoogleSheet = async () => { if (!appsScriptUrl) return null; const response = await fetch(appsScriptUrl); return response.ok ? await response.json() : null; };
    const loadDataFromLocalStorage = () => { enteredRecords = JSON.parse(localStorage.getItem('enteredRecords') || '[]'); barcodeHeader = localStorage.getItem('barcodeHeader') || ''; nameHeader = localStorage.getItem('nameHeader') || ''; renderEnteredRecords(); };
    const enableButtons = (isEnabled) => { [el.searchButton, el.exportButton, el.scanButton].forEach(btn => btn.disabled = !isEnabled); };
    const handleSearch = () => { const barcode = el.searchInput.value.trim(); if (!barcode) return; const foundItem = database.find(item => item[barcodeHeader]?.toString() === barcode); if (foundItem) showWorkspace(foundItem); else showToast('Item not found!'); };
    
    const saveEntry = () => { 
        const entryNodes = el.expiryInputsContainer.querySelectorAll('.entry-card'); 
        if (entryNodes.length === 0) return showToast('Please add at least one expiry entry.'); 
        
        const recordData = editingRecordIndex !== null ? { ...enteredRecords[editingRecordIndex] } : { ...currentItem }; 
        Object.keys(recordData).forEach(key => { if (key.startsWith('expiryDate') || key.startsWith('quantity')) delete recordData[key]; }); 
        
        let hasError = false;
        entryNodes.forEach((node, i) => { 
            const dateInput = node.querySelector('.expiry-date'); 
            const qtyInput = node.querySelector('.quantity-input'); 
            if (!dateInput.value || !qtyInput.value) hasError = true; 
            recordData[`expiryDate${i + 1}`] = dateInput.value; 
            recordData[`quantity${i + 1}`] = parseInt(qtyInput.value, 10) || ''; 
        }); 
        
        if(hasError) return showToast('Please fill all date and quantity fields.'); 
        
        recordData.recordTime = new Date().toLocaleString('en-GB'); 
        if (editingRecordIndex !== null) { 
            enteredRecords[editingRecordIndex] = recordData; 
            showToast('Entry updated successfully!'); 
        } else { 
            enteredRecords.unshift(recordData); 
            showToast(`Entry saved with ${entryNodes.length} expiry date(s)!`); 
        } 
        localStorage.setItem('enteredRecords', JSON.stringify(enteredRecords)); 
        renderEnteredRecords(); 
        hideWorkspace(); 
    };

    const renderEnteredRecords = () => { const table = el.recordsTable; if (enteredRecords.length === 0) { table.innerHTML = '<tbody><tr><td colspan="5" style="text-align:center; padding: 48px; color: var(--text-secondary);">No entries recorded yet.</td></tr></tbody>'; return; } let maxExpiryPairs = 0; enteredRecords.forEach(rec => { const keys = Object.keys(rec).filter(k => k.startsWith('expiryDate')); if (keys.length > maxExpiryPairs) maxExpiryPairs = keys.length; }); let headers = ['Item', 'Barcode']; for (let i = 1; i <= maxExpiryPairs; i++) { headers.push(`Expiry ${i}`); headers.push(`Qty ${i}`); } headers.push('Actions'); const head = `<thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>`; const body = `<tbody>${enteredRecords.map((rec, index) => { let rowHtml = `<tr data-index="${index}"><td>${rec[nameHeader] || '–'}</td><td>${rec[barcodeHeader] || '–'}</td>`; for (let i = 1; i <= maxExpiryPairs; i++) { rowHtml += `<td>${rec[`expiryDate${i}`] || ''}</td><td>${rec[`quantity${i}`] || ''}</td>`; } rowHtml += `<td class="action-cell"><button class="action-btn" onclick="handleEdit(${index})"><span class="material-icons-outlined">edit</span></button><button class="action-btn" onclick="handleDelete(${index})"><span class="material-icons-outlined">delete</span></button></td></tr>`; return rowHtml; }).join('')}</tbody>`; table.innerHTML = head + body; };
    const handleDelete = (index) => { if (confirm(`Are you sure you want to delete the entry for "${enteredRecords[index][nameHeader]}"?`)) { enteredRecords.splice(index, 1); localStorage.setItem('enteredRecords', JSON.stringify(enteredRecords)); renderEnteredRecords(); showToast('Entry deleted.'); } };
    const handleEdit = (index) => { editingRecordIndex = index; const recordToEdit = enteredRecords[index]; showWorkspace(recordToEdit); el.expiryInputsContainer.innerHTML = ''; let i = 1; while (recordToEdit[`expiryDate${i}`]) { addExpiryEntry(recordToEdit[`expiryDate${i}`], recordToEdit[`quantity${i}`]); i++; } };
    
    // --- Barcode Scanner Logic ---
    let scannerState = { stream: null, isScanning: false, facingMode: 'environment', detectionInterval: null, barcodeDetector: null };
    const isBarcodeDetectionSupported = () => 'BarcodeDetector' in window;
    async function initScanner() { if (!isBarcodeDetectionSupported()) { showToast('Barcode Detection API not supported.'); el.scanButton.disabled = true; return; } try { const supportedFormats = await BarcodeDetector.getSupportedFormats(); scannerState.barcodeDetector = new BarcodeDetector({ formats: supportedFormats }); } catch (error) { console.error("Error initializing BarcodeDetector:", error); showToast('Could not initialize barcode scanner.'); el.scanButton.disabled = true; } }
    async function startScanner() { if (!scannerState.barcodeDetector) { showToast('Scanner not ready.'); return; } el.scannerModal.classList.add('visible'); el.scannerStatus.textContent = 'Starting camera...'; try { const constraints = { video: { facingMode: scannerState.facingMode, width: { ideal: 1280 }, height: { ideal: 720 } } }; scannerState.stream = await navigator.mediaDevices.getUserMedia(constraints); el.scannerVideo.srcObject = scannerState.stream; scannerState.isScanning = true; el.scannerStatus.textContent = 'Point camera at a barcode...'; detectBarcodes(); } catch (error) { console.error('Error starting camera:', error); el.scannerStatus.textContent = `Camera error: ${error.name}`; showToast(`Camera error: ${error.message}`); stopScanner(); } }
    function stopScanner() { scannerState.isScanning = false; if (scannerState.detectionInterval) { clearInterval(scannerState.detectionInterval); scannerState.detectionInterval = null; } if (scannerState.stream) { scannerState.stream.getTracks().forEach(track => track.stop()); scannerState.stream = null; el.scannerVideo.srcObject = null; } el.scannerModal.classList.remove('visible'); }
    function switchCamera() { scannerState.facingMode = scannerState.facingMode === 'environment' ? 'user' : 'environment'; if (scannerState.isScanning) { stopScanner(); startScanner(); } }
    function detectBarcodes() { if (!scannerState.isScanning) return; scannerState.detectionInterval = setInterval(async () => { if (!scannerState.isScanning || !scannerState.barcodeDetector) return; try { const barcodes = await scannerState.barcodeDetector.detect(el.scannerVideo); if (barcodes.length > 0) { handleBarcodeDetected(barcodes[0]); } } catch (error) { console.error('Barcode detection error:', error); } }, 300); }
    function handleBarcodeDetected(barcode) { const detectedValue = barcode.rawValue; stopScanner(); el.searchInput.value = detectedValue; handleSearch(); showToast(`Scanned: ${detectedValue}`); }

    // === EVENT LISTENERS ===
    document.addEventListener('DOMContentLoaded', () => { initializeApp(); initScanner(); });
    el.syncButton.addEventListener('click', initializeApp);
    el.searchButton.addEventListener('click', handleSearch);
    el.searchInput.addEventListener('keydown', e => { if (e.key === 'Enter') handleSearch(); });
    el.addExpiryButton.addEventListener('click', () => addExpiryEntry());
    el.discardButton.addEventListener('click', hideWorkspace);
    el.saveButton.addEventListener('click', saveEntry);
    el.exportButton.addEventListener('click', () => { if (enteredRecords.length === 0) return showToast('No records to export!'); if (confirm("Export entries to Excel and clear them from this session?")) { const ws = XLSX.utils.json_to_sheet(enteredRecords); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Inventory Records'); XLSX.writeFile(wb, `inventory_records_${new Date().toISOString().slice(0,10)}.xlsx`); enteredRecords = []; localStorage.setItem('enteredRecords', '[]'); renderEnteredRecords(); showToast("Data exported and cleared."); } });
    el.scanButton.addEventListener('click', startScanner);
    el.scannerCloseButton.addEventListener('click', stopScanner);
    el.scannerSwitchButton.addEventListener('click', switchCamera);
</script>

</body>
</html>
